---
- hosts: localhost
  gather_facts: false
  vars:
    current_date: "{{ lookup('pipe','date +%Y-%m-%d') }}"
    git_dirs:
      - /infra
      - /infra/roles

  tasks:
    - name: Commit and push in git directories
      shell: |
        git add .
        if ! git diff-index --quiet HEAD --; then
          git commit -m "{{ current_date }} - автоматический коммит"
          git push origin master
          echo "В папке {{ item }} изменения были запушены"
        else
          echo "В папке {{ item }} нет изменений для коммита"
        fi
      args:
        chdir: "{{ item }}"
      loop: "{{ git_dirs }}"
      changed_when: false
