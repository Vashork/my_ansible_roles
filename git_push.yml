---
- hosts: localhost
  gather_facts: false
  vars:
    current_date: "{{ lookup('pipe','date +%Y-%m-%d') }}"
    git_dirs:
      - /infra
      - /infra/roles

  tasks:
    - name: Commit and push in git directories
      shell: |
        git add .
        if ! git diff-index --quiet HEAD --; then
          git commit -m "{{ current_date }} - автоматический коммит"
          git push origin master
          printf "В папке %s изменения были запушены\n" "{{ item }}"
        else
          printf "В папке %s нет изменений для коммита\n" "{{ item }}"
        fi
      args:
        chdir: "{{ item }}"
      loop: "{{ git_dirs }}"
      changed_when: false
      register: git_result

    - name: Print results directly
      debug:
        msg: "{{ item.stdout_lines[-1] }}"
      loop: "{{ git_result.results }}"
      when: false
